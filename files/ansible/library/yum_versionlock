#!/bin/bash
# WANT_JSON

name=`jq -r .name < $1`
version=`jq -r .version < $1`

changed='false'

versionlock()
{
  if ! echo "${versionlock_list}" | grep -q ":${1}-${2}" >/dev/null 2>&1; then
    yum versionlock delete "${1}" >/dev/null 2>&1
    OUTPUT=`yum versionlock "${1}-${2}" 2>&1`

    if yum versionlock list | grep -q ":${1}-${2}" >/dev/null 2>&1; then
      changed='true'
    else
      echo "{\"failed\": true, \"msg\": \"Could not versionlock '${1}-${2}'\", \"stdout\": \"${OUTPUT}\"}"
      exit 1
    fi
  fi
}

versionlock_list="`yum versionlock list`"

versionlock "${name}" "${version}"

# Also versionlock all dependencies which have ${name} in their name
for package in `yum deplist "${name}-${version}" | sed -ne 's/ *provider: \([^ ]\+\)\(\.x86_64\|\.i.86\) \(.*\)/\1/p' | grep "\(^\|-\)${name}\($\|-\)"`; do
  versionlock "${package}" "${version}"
done

echo "{\"changed\": ${changed}}"
