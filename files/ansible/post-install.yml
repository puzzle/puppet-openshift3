- name: Prepare hosts for OpenShift installation
  become: False
  hosts: nodes

  tasks:
    - name: Workaround for k8s#13511
      ini_file: dest=/usr/lib/systemd/system/atomic-openshift-node.service
                section=Service
                option=KillMode
                value=process
      notify:
        - reload systemd

    - name: Configure OpenShift Gluster plugin logrotate
      copy: src=files/glusterfs-plugin dest=/etc/logrotate.d owner=root group=root mode=0644 setype=etc_t

    - name: Update OpenShift packages on control machine
      local_action: yum name={{ openshift_package_name }} state=latest
      run_once: true

    - name: Install Ansible post-install roles
      local_action: "command ansible-galaxy install -p roles --force {% if item.scm is defined and item.scm %}{{item.scm}}+{%endif%}{{ item.src }}{% if item.version is defined and item.version %},{{ item.version }}{%endif%}"
      run_once: true
      with_items: "{{ appuio_ansible_post_install_roles | default([]) }}"

  handlers:
    - name: restart Docker
      service: name=docker state=restarted

    - name: restart OpenShift node
      service: name={{ openshift_package_name }}-node state=restarted

    - name: reload systemd
      command: systemctl daemon-reload
